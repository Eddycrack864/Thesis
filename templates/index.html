<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector de Mangos Exportables</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .video-container {
            position: relative;
            width: 100%;
            height: 480px;
            background-color: #000;
            overflow: hidden;
        }
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 10;
            display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Detector de Mangos Exportables</h1>

        <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-center mb-6">
                <button id="startCamera" class="bg-green-500 text-white px-6 py-2 rounded-lg mr-4 hover:bg-green-600 transition-colors duration-200">
                    Iniciar Cámara
                </button>
                <button id="stopCamera" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors duration-200" disabled>
                    Detener Cámara
                </button>
            </div>

            <div id="statusDisplay" class="mb-4 text-center hidden">
                <p id="modelStatus" class="font-semibold text-blue-600"></p>
            </div>

            <div class="video-container rounded-lg">
                <img id="videoFeed" src="" alt="Video Feed" class="w-full h-full object-contain hidden">
                <div id="placeholder" class="absolute inset-0 flex items-center justify-center text-white">
                    <p>Presiona "Iniciar Cámara" para comenzar</p>
                </div>
                <div id="errorOverlay" class="error-overlay">
                    <div class="spinner"></div>
                    <p id="errorMessage" class="text-center">Reconectando...</p>
                    <button id="retryButton" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 hidden">
                        Reintentar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            let isRunning = false;
            let statusCheckInterval;
            let reconnectAttempts = 0;
            const MAX_RECONNECT_ATTEMPTS = 3;
            let videoFeed = document.getElementById('videoFeed');

            function showError(message, showRetry = true) {
                $('#errorOverlay').show();
                $('#errorMessage').text(message);
                if (showRetry) {
                    $('#retryButton').removeClass('hidden');
                } else {
                    $('#retryButton').addClass('hidden');
                }
            }

            function hideError() {
                $('#errorOverlay').hide();
                $('#retryButton').addClass('hidden');
            }

            function resetVideo() {
                isRunning = false;
                $('#videoFeed').addClass('hidden').attr('src', '');
                $('#placeholder').removeClass('hidden');
                $('#startCamera').prop('disabled', false);
                $('#stopCamera').prop('disabled', true);
                $('#statusDisplay').addClass('hidden');
                hideError();
                clearInterval(statusCheckInterval);
            }

            function handleVideoError() {
                if (isRunning) {
                    reconnectAttempts++;
                    if (reconnectAttempts <= MAX_RECONNECT_ATTEMPTS) {
                        showError(`Reconectando... Intento ${reconnectAttempts} de ${MAX_RECONNECT_ATTEMPTS}`);
                        setTimeout(reconnectVideo, 2000);
                    } else {
                        showError('No se pudo reconectar. Por favor, intente nuevamente.', true);
                        resetVideo();
                    }
                }
            }

            function reconnectVideo() {
                if (isRunning) {
                    const timestamp = new Date().getTime();
                    $('#videoFeed').attr('src', `/video_feed?t=${timestamp}`);
                }
            }

            function checkCameraStatus() {
                $.get('/camera_status')
                    .done(function(data) {
                        if (!data.running && isRunning) {
                            resetVideo();
                        }

                        if (data.running) {
                            hideError();
                            let statusText = "";
                            if (data.model_stage === 1) {
                                statusText = "Ejecutando modelo exportabilidad.pt (detección de mangos)";
                            } else if (data.model_stage === 2) {
                                statusText = "Ejecutando modelo madurez.pt (análisis de madurez)";
                            } else if (data.model_stage === 3) {
                                statusText = "Ejecutando modelo defectos.pt (detección de defectos)";
                            }

                            if (statusText) {
                                $('#modelStatus').text(statusText);
                                $('#statusDisplay').removeClass('hidden');
                            }
                        }
                    })
                    .fail(function() {
                        handleVideoError();
                    });
            }

            videoFeed.onerror = handleVideoError;

            $('#startCamera').click(function() {
                reconnectAttempts = 0;
                $.get('/start_camera')
                    .done(function(data) {
                        if (data.status === 'success') {
                            isRunning = true;
                            hideError();
                            $('#videoFeed').attr('src', '/video_feed').removeClass('hidden');
                            $('#placeholder').addClass('hidden');
                            $('#startCamera').prop('disabled', true);
                            $('#stopCamera').prop('disabled', false);
                            statusCheckInterval = setInterval(checkCameraStatus, 500);
                        } else {
                            showError(data.message || 'Error al iniciar la cámara', true);
                        }
                    })
                    .fail(function() {
                        showError('Error al conectar con el servidor', true);
                    });
            });

            $('#stopCamera').click(function() {
                $.get('/stop_camera')
                    .done(function(data) {
                        if (data.status === 'success') {
                            resetVideo();
                        }
                    })
                    .fail(function() {
                        showError('Error al detener la cámara', true);
                    });
            });

            $('#retryButton').click(function() {
                reconnectAttempts = 0;
                hideError();
                $('#startCamera').click();
            });
        });
    </script>
</body>
</html>